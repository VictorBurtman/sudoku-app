<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Sudoku</title>
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Mon Sudoku">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1vbiBTdWRva3UiLAogICJzaG9ydF9uYW1lIjogIlN1ZG9rdSIsCiAgImRlc2NyaXB0aW9uIjogIkpldSBkZSBTdWRva3UgcGVyc29ubmFsaXPDqSIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMyMTk2RjMiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlOVEV5SWlCb1pXbG5hSFE5SWpVeE1pSWdkbWxsZDBKdmVEMGlNQ0F3SURVNE5DQTBPRFFpSUdobGNtaHNhVzVyUFNKb2RIUndjem92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIaHRiRzV6UFNKb2RIUndjem92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUNpQWdJQ0FnYVdROUluTjJaekl5TnpFaUlIaHRiRzV6T21oc2FXNXJQU0pvZEhSd2N6b3ZMM2QzZHk1M015NXZjbWN2TVRrNU9TOXNiR2x1YXlJK0NpQWdQR2RsY21Gc1pYUmhjbUJ6ZEhKdmEyVTlJbTV2Ym1VaUlHWnBiR3c5SWpBeE5qUkdRa0lpTHo0S0lDQThaV3hzYVhCelpTQmplRDBpTWpRM0lpQmplVDBpTWpRM0lpQnllRDBpTnpraUlHWnBiR3c5SWpBeE5qUkdRa0lpTHo0S0lDQThaV3hzYVhCelpTQmplRDBpTXpZMUlpQmplVDBpTWpRM0lpQnllRDBpTnpraUlHWnBiR3c5SWpBeE5qUkdRa0lpTHo0S0lDQThaV3hzYVhCelpTQmplRDBpTXpZMUlpQmplVDBpTXpZMUlpQnllRDBpTnpraUlHWnBiR3c5SWpBeE5qUkdRa0lpTHo0S1BDOXpkbWMrIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #121212;
            color: #ffffff;
            user-select: none;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background: #1e1e1e;
            min-height: 100vh;
        }

        .app-bar {
            background: #2d2d2d;
            padding: 16px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
        }

        .app-subtitle {
            font-size: 12px;
            color: #b0b0b0;
        }

        .app-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .timer-display {
            background: #1a237e;
            border: 1px solid #3f51b5;
            border-radius: 6px;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: bold;
            color: #90caf9;
        }

        .error-display {
            font-weight: bold;
            font-size: 14px;
            color: #ffffff;
        }

        .menu-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            padding: 20px;
        }

        .main-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffffff;
        }

        .subtitle {
            font-size: 18px;
            color: #b0b0b0;
            margin-bottom: 10px;
        }

        .warning-text {
            font-size: 12px;
            color: #ff9800;
            font-style: italic;
            margin-bottom: 30px;
        }

        .option-button, .difficulty-button {
            width: 200px;
            height: 60px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .option-button {
            background: #404040;
            color: #ffffff;
            height: 50px;
        }

        .option-button:hover {
            background: #505050;
        }

        .game-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }

        .sudoku-grid {
            width: 360px;
            height: 360px;
            border: 3px solid #ffffff;
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            margin-bottom: 20px;
        }

        .sudoku-cell {
            border: 0.5px solid #666666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            background: #2d2d2d;
            color: #ffffff;
        }

        .sudoku-cell.thick-right { border-right: 2px solid #ffffff; }
        .sudoku-cell.thick-bottom { border-bottom: 2px solid #ffffff; }
        .sudoku-cell.selected { background: #ff9800; }
        .sudoku-cell.error { background: #d32f2f; }
        .sudoku-cell.highlight-number { background: #f57c00; }
        .sudoku-cell.highlight-area { background: #424242; }
        .sudoku-cell.original { color: #ffffff; }
        .sudoku-cell.user { color: #90caf9; }

        .notes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1px;
            padding: 2px;
        }

        .note {
            width: 10px;
            height: 10px;
            background: #1a237e;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #90caf9;
            font-weight: bold;
        }

        .note.highlighted {
            background: #f57c00;
            color: #ffffff;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .action-button {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
        }

        .notes-button {
            background: #404040;
            color: #ffffff;
        }

        .notes-button.active {
            background: #9c27b0;
            color: #ffffff;
        }

        .undo-button {
            background: #404040;
            color: #ffffff;
        }

        .action-button:hover {
            opacity: 0.8;
        }

        .notes-toggle {
            display: none;
        }

        .number-buttons {
            display: flex;
            flex-wrap: nowrap;
            gap: 4px;
            justify-content: center;
            overflow-x: auto;
            width: 100%;
            max-width: 400px;
        }

        .number-button {
            min-width: 38px;
            width: 38px;
            height: 50px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background: #404040;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .number-button:hover {
            background: #505050;
        }

        .number-button.erase {
            background: #d32f2f;
            font-size: 18px;
        }

        .number-button.erase:hover {
            background: #f44336;
        }

        .number-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .remaining-count {
            font-size: 10px;
            color: #b0b0b0;
            font-weight: bold;
            margin-top: 2px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: #2d2d2d;
            color: #ffffff;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            border: 1px solid #404040;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ffffff;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary { 
            background: #2196f3; 
            color: white; 
        }
        
        .btn-primary:hover { 
            background: #1976d2; 
        }

        .btn-secondary { 
            background: #404040; 
            color: #ffffff; 
        }
        
        .btn-secondary:hover { 
            background: #505050; 
        }

        .option-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #404040;
        }

        .option-item:last-child { border-bottom: none; }

        .option-details {
            flex: 1;
            margin-left: 12px;
        }

        .option-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: #ffffff;
        }

        .option-subtitle {
            font-size: 12px;
            color: #b0b0b0;
        }

        .hidden { display: none !important; }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #ffffff;
        }

        /* Responsive pour petits √©crans */
        @media (max-width: 400px) {
            .sudoku-grid {
                width: 320px;
                height: 320px;
            }
            
            .number-button {
                min-width: 32px;
                width: 32px;
                height: 45px;
                font-size: 14px;
            }
            
            .number-buttons {
                gap: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Menu Principal -->
        <div id="menuScreen" class="screen">
            <div class="app-bar">
                <div>
                    <div class="app-title">Mon Sudoku</div>
                </div>
            </div>
            <div class="menu-screen">
                <div class="main-title">SUDOKU</div>
                <div class="subtitle">Choisissez votre niveau</div>
                <div class="warning-text">‚ö†Ô∏è Premier chargement peut prendre 50+ secondes</div>
                
                <button class="option-button" onclick="showOptionsModal()">
                    <span>‚öôÔ∏è</span>
                    <span>Options</span>
                </button>
                
                <button class="difficulty-button" style="background: #4caf50; color: white;" onclick="startGame('easy', 'Facile')">Facile</button>
                <button class="difficulty-button" style="background: #ff9800; color: white;" onclick="startGame('medium', 'Moyen')">Moyen</button>
                <button class="difficulty-button" style="background: #f44336; color: white;" onclick="startGame('hard', 'Difficile')">Difficile</button>
            </div>
        </div>

        <!-- √âcran de Jeu -->
        <div id="gameScreen" class="screen hidden">
            <div class="app-bar">
                <div>
                    <div class="app-title" id="gameTitle">Sudoku</div>
                    <div class="app-subtitle" id="gameSource">Source: API</div>
                </div>
                <div class="app-actions">
                    <div id="timerDisplay" class="timer-display hidden">
                        <span>‚è±Ô∏è</span>
                        <span id="timerText">0s</span>
                    </div>
                    <div id="errorDisplay" class="error-display hidden"></div>
                    <button class="btn btn-secondary" onclick="resetGame()">üîÑ</button>
                </div>
            </div>
            
            <div class="game-screen">
                <div class="sudoku-grid" id="sudokuGrid"></div>
                
                <div class="controls">
                    <div class="action-buttons">
                        <button class="action-button notes-button" id="notesButton" onclick="toggleNotesMode()">‚úèÔ∏è</button>
                        <button class="action-button undo-button" onclick="undoLastAction()">‚Ü∂</button>
                    </div>
                    
                    <div class="number-buttons" id="numberButtons"></div>
                </div>
            </div>
        </div>

        <!-- Modales -->
        <div id="optionsModal" class="modal">
            <div class="modal-content">
                <div class="modal-title">Options de jeu</div>
                <div id="optionsContent"></div>
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="closeOptionsModal()">Fermer</button>
                </div>
            </div>
        </div>

        <div id="gameOverModal" class="modal">
            <div class="modal-content">
                <div class="modal-title" id="gameOverTitle"></div>
                <div id="gameOverContent"></div>
                <div class="modal-actions" id="gameOverActions"></div>
            </div>
        </div>

        <div id="loadingModal" class="modal">
            <div class="modal-content">
                <div class="loading">
                    <div style="margin-right: 10px;">‚è≥</div>
                    <div>Chargement de la grille...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // √âtat global de l'application
        let gameState = {
            currentGrid: [],
            originalGrid: [],
            errorGrid: [],
            notesGrid: [],
            selectedRow: null,
            selectedCol: null,
            errorCount: 0,
            gameWon: false,
            gameLost: false,
            notesMode: false,
            startTime: null,
            elapsedTime: 0,
            gameTimer: null,
            difficulty: '',
            source: '',
            actionHistory: [] // Historique des actions pour annulation
        };

        let options = {
            indicativeMode: false,
            highlightMode: true,
            showTimer: true
        };

        // Charger les options sauvegard√©es
        function loadOptions() {
            const saved = localStorage.getItem('sudoku_options');
            if (saved) {
                try {
                    options = {...options, ...JSON.parse(saved)};
                } catch (e) {
                    console.log('Erreur chargement options:', e);
                }
            }
        }

        function saveOptions() {
            localStorage.setItem('sudoku_options', JSON.stringify(options));
        }

        // Navigation entre √©crans
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        // R√©cup√©ration de grille depuis l'API
        async function fetchSudokuGrid(difficulty) {
            const response = await fetch(`https://sugoku.onrender.com/board?difficulty=${difficulty}`);
            if (!response.ok) throw new Error('Erreur API');
            const data = await response.json();
            return data.board;
        }

        // D√©marrer une nouvelle partie
        async function startGame(difficulty, label) {
            document.getElementById('loadingModal').classList.add('show');
            
            try {
                const grid = await fetchSudokuGrid(difficulty);
                initializeGame(grid, label, difficulty);
                showScreen('gameScreen');
            } catch (e) {
                alert('Impossible de r√©cup√©rer une grille. V√©rifiez votre connexion internet.');
            } finally {
                document.getElementById('loadingModal').classList.remove('show');
            }
        }

        function initializeGame(grid, difficultyLabel, difficulty) {
            gameState.originalGrid = grid.map(row => [...row]);
            gameState.currentGrid = grid.map(row => [...row]);
            gameState.errorGrid = Array(9).fill().map(() => Array(9).fill(false));
            gameState.notesGrid = Array(9).fill().map(() => Array(9).fill().map(() => new Set()));
            gameState.selectedRow = null;
            gameState.selectedCol = null;
            gameState.errorCount = 0;
            gameState.gameWon = false;
            gameState.gameLost = false;
            gameState.notesMode = false;
            gameState.startTime = Date.now();
            gameState.elapsedTime = 0;
            gameState.difficulty = difficultyLabel;
            gameState.source = 'Sugoku API';
            gameState.actionHistory = [];

            document.getElementById('gameTitle').textContent = `Sudoku - ${difficultyLabel}`;
            document.getElementById('gameSource').textContent = `Source: Sugoku API (${difficulty})`;

            clearInterval(gameState.gameTimer);
            if (options.showTimer) {
                startTimer();
            }

            renderGame();
        }

        function saveAction(action) {
            gameState.actionHistory.push(action);
            // Limiter l'historique √† 50 actions
            if (gameState.actionHistory.length > 50) {
                gameState.actionHistory.shift();
            }
        }

        function undoLastAction() {
            if (gameState.actionHistory.length === 0) return;
            
            const lastAction = gameState.actionHistory.pop();
            
            if (lastAction.type === 'number') {
                gameState.currentGrid[lastAction.row][lastAction.col] = lastAction.oldValue;
                if (lastAction.oldNotes) {
                    gameState.notesGrid[lastAction.row][lastAction.col] = new Set(lastAction.oldNotes);
                }
            } else if (lastAction.type === 'note') {
                if (lastAction.action === 'add') {
                    gameState.notesGrid[lastAction.row][lastAction.col].delete(lastAction.number);
                } else {
                    gameState.notesGrid[lastAction.row][lastAction.col].add(lastAction.number);
                }
            }
            
            if (options.indicativeMode) {
                updateErrors();
            }
            
            renderGame();
        }

        function startTimer() {
            gameState.gameTimer = setInterval(() => {
                if (!gameState.gameWon && !gameState.gameLost) {
                    gameState.elapsedTime = Date.now() - gameState.startTime;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerEl = document.getElementById('timerDisplay');
            if (options.showTimer) {
                timerEl.classList.remove('hidden');
                document.getElementById('timerText').textContent = formatTime(gameState.elapsedTime);
            } else {
                timerEl.classList.add('hidden');
            }
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${(minutes % 60).toString().padStart(2, '0')}m ${(seconds % 60).toString().padStart(2, '0')}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${(seconds % 60).toString().padStart(2, '0')}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function renderGame() {
            renderGrid();
            renderNumberButtons();
            updateErrorDisplay();
            updateTimerDisplay();
        }

        function renderGrid() {
            const grid = document.getElementById('sudokuGrid');
            grid.innerHTML = '';

            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'sudoku-cell';
                    
                    // Bordures √©paisses
                    if ((col + 1) % 3 === 0 && col !== 8) cell.classList.add('thick-right');
                    if ((row + 1) % 3 === 0 && row !== 8) cell.classList.add('thick-bottom');
                    
                    // √âtats de la case
                    if (gameState.selectedRow === row && gameState.selectedCol === col) {
                        cell.classList.add('selected');
                    }
                    
                    if (options.indicativeMode && gameState.errorGrid[row][col]) {
                        cell.classList.add('error');
                    }
                    
                    // Surbrillance
                    if (options.highlightMode && gameState.selectedRow !== null && gameState.selectedCol !== null) {
                        const selectedValue = gameState.currentGrid[gameState.selectedRow][gameState.selectedCol];
                        
                        // Surligner ligne, colonne, carr√©
                        if (row === gameState.selectedRow || col === gameState.selectedCol) {
                            cell.classList.add('highlight-area');
                        }
                        
                        const selectedBlockRow = Math.floor(gameState.selectedRow / 3);
                        const selectedBlockCol = Math.floor(gameState.selectedCol / 3);
                        const currentBlockRow = Math.floor(row / 3);
                        const currentBlockCol = Math.floor(col / 3);
                        
                        if (selectedBlockRow === currentBlockRow && selectedBlockCol === currentBlockCol) {
                            cell.classList.add('highlight-area');
                        }
                        
                        // Surligner chiffres identiques
                        if (selectedValue !== 0 && gameState.currentGrid[row][col] === selectedValue) {
                            cell.classList.add('highlight-number');
                        }
                        
                        // Pour les notes, on ne surligne plus toute la case
                        // La surbrillance des notes individuelles est g√©r√©e plus bas
                    }
                    
                    cell.onclick = () => selectCell(row, col);
                    
                    // Contenu de la case
                    if (gameState.currentGrid[row][col] !== 0) {
                        cell.textContent = gameState.currentGrid[row][col];
                        cell.classList.add(gameState.originalGrid[row][col] !== 0 ? 'original' : 'user');
                    } else if (gameState.notesGrid[row][col].size > 0) {
                        const notesContainer = document.createElement('div');
                        notesContainer.className = 'notes-container';
                        
                        gameState.notesGrid[row][col].forEach(note => {
                            const noteEl = document.createElement('div');
                            noteEl.className = 'note';
                            noteEl.textContent = note;
                            
                            // Surligner les notes si elles correspondent au chiffre s√©lectionn√©
                            if (options.highlightMode && gameState.selectedRow !== null && gameState.selectedCol !== null) {
                                const selectedValue = gameState.currentGrid[gameState.selectedRow][gameState.selectedCol];
                                if (selectedValue !== 0 && note === selectedValue) {
                                    noteEl.classList.add('highlighted');
                                }
                            }
                            
                            notesContainer.appendChild(noteEl);
                        });
                        
                        cell.appendChild(notesContainer);
                    }
                    
                    grid.appendChild(cell);
                }
            }
        }

        function selectCell(row, col) {
            gameState.selectedRow = row;
            gameState.selectedCol = col;
            renderGame();
        }

        function renderNumberButtons() {
            const container = document.getElementById('numberButtons');
            container.innerHTML = '';
            
            const remaining = options.indicativeMode ? getRemainingNumbers() : {};
            
            for (let i = 1; i <= 9; i++) {
                const isVisible = !options.indicativeMode || (remaining[i] || 0) > 0;
                
                if (isVisible) {
                    const btn = document.createElement('button');
                    btn.className = 'number-button';
                    btn.onclick = () => placeNumber(i);
                    
                    const numberText = document.createElement('div');
                    numberText.textContent = i;
                    btn.appendChild(numberText);
                    
                    if (options.indicativeMode) {
                        const countText = document.createElement('div');
                        countText.className = 'remaining-count';
                        countText.textContent = remaining[i] || 0;
                        btn.appendChild(countText);
                    }
                    
                    container.appendChild(btn);
                }
            }

            // Bouton pour effacer (placer 0)
            const eraseBtn = document.createElement('button');
            eraseBtn.className = 'number-button';
            eraseBtn.style.background = '#d32f2f';
            eraseBtn.textContent = '√ó';
            eraseBtn.onclick = () => placeNumber(0);
            container.appendChild(eraseBtn);
        }

        function getRemainingNumbers() {
            const remaining = {};
            for (let i = 1; i <= 9; i++) remaining[i] = 9;
            
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const number = gameState.currentGrid[row][col];
                    if (number !== 0) {
                        remaining[number] = (remaining[number] || 0) - 1;
                    }
                }
            }
            
            return remaining;
        }

        function placeNumber(number) {
            if (gameState.selectedRow === null || gameState.selectedCol === null || gameState.gameWon || gameState.gameLost) return;
            if (gameState.originalGrid[gameState.selectedRow][gameState.selectedCol] !== 0) return;

            if (gameState.notesMode && number !== 0) {
                if (gameState.notesGrid[gameState.selectedRow][gameState.selectedCol].has(number)) {
                    gameState.notesGrid[gameState.selectedRow][gameState.selectedCol].delete(number);
                } else {
                    gameState.notesGrid[gameState.selectedRow][gameState.selectedCol].add(number);
                }
            } else {
                gameState.currentGrid[gameState.selectedRow][gameState.selectedCol] = number;
                if (number !== 0) {
                    gameState.notesGrid[gameState.selectedRow][gameState.selectedCol].clear();
                }
            }

            if (options.indicativeMode) {
                updateErrors();
                if (gameState.errorCount >= 3) {
                    gameState.gameLost = true;
                    gameState.elapsedTime = Date.now() - gameState.startTime;
                    showGameOverModal(false);
                    return;
                }
            }

            if (isSudokuComplete()) {
                gameState.gameWon = true;
                gameState.elapsedTime = Date.now() - gameState.startTime;
                showGameOverModal(true);
            }

            renderGame();
        }

        function isValidMove(row, col, number) {
            for (let c = 0; c < 9; c++) {
                if (c !== col && gameState.currentGrid[row][c] === number) return false;
            }
            
            for (let r = 0; r < 9; r++) {
                if (r !== row && gameState.currentGrid[r][col] === number) return false;
            }
            
            const startRow = Math.floor(row / 3) * 3;
            const startCol = Math.floor(col / 3) * 3;
            for (let r = startRow; r < startRow + 3; r++) {
                for (let c = startCol; c < startCol + 3; c++) {
                    if ((r !== row || c !== col) && gameState.currentGrid[r][c] === number) return false;
                }
            }
            
            return true;
        }

        function isSudokuComplete() {
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (gameState.currentGrid[row][col] === 0) return false;
                    if (!isValidMove(row, col, gameState.currentGrid[row][col])) return false;
                }
            }
            return true;
        }

        function updateErrors() {
            gameState.errorCount = 0;
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (gameState.currentGrid[row][col] !== 0 && gameState.originalGrid[row][col] === 0) {
                        gameState.errorGrid[row][col] = !isValidMove(row, col, gameState.currentGrid[row][col]);
                        if (gameState.errorGrid[row][col]) gameState.errorCount++;
                    } else {
                        gameState.errorGrid[row][col] = false;
                    }
                }
            }
        }

        function updateErrorDisplay() {
            const errorEl = document.getElementById('errorDisplay');
            if (options.indicativeMode) {
                errorEl.classList.remove('hidden');
                errorEl.textContent = `Erreurs: ${gameState.errorCount}/3`;
                errorEl.style.color = gameState.errorCount >= 2 ? '#f44336' : '#000';
            } else {
                errorEl.classList.add('hidden');
            }
        }

        function toggleNotesMode() {
            gameState.notesMode = !gameState.notesMode;
            const checkbox = document.getElementById('notesCheckbox');
            const icon = document.getElementById('notesIcon');
            
            if (gameState.notesMode) {
                checkbox.classList.add('checked');
                checkbox.textContent = '‚úì';
                icon.style.color = '#9c27b0';
            } else {
                checkbox.classList.remove('checked');
                checkbox.textContent = '';
                icon.style.color = '#666';
            }
        }

        function resetGame() {
            gameState.currentGrid = gameState.originalGrid.map(row => [...row]);
            gameState.errorGrid = Array(9).fill().map(() => Array(9).fill(false));
            gameState.notesGrid = Array(9).fill().map(() => Array(9).fill().map(() => new Set()));
            gameState.selectedRow = null;
            gameState.selectedCol = null;
            gameState.errorCount = 0;
            gameState.gameWon = false;
            gameState.gameLost = false;
            gameState.notesMode = false;
            gameState.startTime = Date.now();
            gameState.elapsedTime = 0;
            gameState.actionHistory = [];

            // R√©initialiser le bouton notes
            document.getElementById('notesButton').classList.remove('active');

            clearInterval(gameState.gameTimer);
            if (options.showTimer) {
                startTimer();
            }

            renderGame();
        }

        function showGameOverModal(won) {
            const modal = document.getElementById('gameOverModal');
            const title = document.getElementById('gameOverTitle');
            const content = document.getElementById('gameOverContent');
            const actions = document.getElementById('gameOverActions');

            clearInterval(gameState.gameTimer);

            title.textContent = won ? 'üéâ F√©licitations !' : 'üí• Partie termin√©e';
            
            if (won) {
                content.innerHTML = `
                    <p>Vous avez r√©solu le sudoku !</p>
                    <div style="margin-top: 15px; padding: 12px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        <span>‚è±Ô∏è</span>
                        <strong>Temps: ${formatTime(gameState.elapsedTime)}</strong>
                    </div>
                `;
            } else {
                content.innerHTML = '<p>Vous avez fait trop d\'erreurs (3 max).</p>';
            }

            actions.innerHTML = `
                <button class="btn btn-secondary" onclick="closeGameOverModal(); showScreen('menuScreen')">Menu principal</button>
                ${!won ? '<button class="btn btn-primary" onclick="closeGameOverModal(); resetGame()">Recommencer</button>' : ''}
            `;

            modal.classList.add('show');
        }

        function closeGameOverModal() {
            document.getElementById('gameOverModal').classList.remove('show');
        }

        function showOptionsModal() {
            const modal = document.getElementById('optionsModal');
            const content = document.getElementById('optionsContent');

            content.innerHTML = `
                <div class="option-item">
                    <div class="checkbox ${options.indicativeMode ? 'checked' : ''}" 
                         onclick="toggleOption('indicativeMode')">
                        ${options.indicativeMode ? '‚úì' : ''}
                    </div>
                    <div class="option-details">
                        <div class="option-title">Mode indicatif</div>
                        <div class="option-subtitle">Indique les erreurs en rouge. 3 erreurs = d√©faite</div>
                    </div>
                </div>
                <div class="option-item">
                    <div class="checkbox ${options.highlightMode ? 'checked' : ''}" 
                         onclick="toggleOption('highlightMode')">
                        ${options.highlightMode ? '‚úì' : ''}
                    </div>
                    <div class="option-details">
                        <div class="option-title">Surbrillance</div>
                        <div class="option-subtitle">Surligne ligne/colonne et chiffres identiques</div>
                    </div>
                </div>
                <div class="option-item">
                    <div class="checkbox ${options.showTimer ? 'checked' : ''}" 
                         onclick="toggleOption('showTimer')">
                        ${options.showTimer ? '‚úì' : ''}
                    </div>
                    <div class="option-details">
                        <div class="option-title">Afficher timer</div>
                        <div class="option-subtitle">Montre le temps √©coul√© pendant le jeu</div>
                    </div>
                </div>
            `;

            modal.classList.add('show');
        }

        function toggleOption(optionName) {
            options[optionName] = !options[optionName];
            saveOptions();
            
            // Red√©marrer le timer si n√©cessaire
            if (optionName === 'showTimer') {
                clearInterval(gameState.gameTimer);
                if (options.showTimer && !gameState.gameWon && !gameState.gameLost) {
                    startTimer();
                }
            }
            
            showOptionsModal(); // Rafra√Æchir l'affichage
            if (document.getElementById('gameScreen').classList.contains('hidden') === false) {
                renderGame(); // Rafra√Æchir le jeu si on y est
            }
        }

        function closeOptionsModal() {
            document.getElementById('optionsModal').classList.remove('show');
        }

        // Installation PWA
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Afficher un bouton d'installation discret
            if (!localStorage.getItem('pwa_install_dismissed')) {
                setTimeout(() => {
                    if (confirm('Installer cette app sur votre √©cran d\'accueil pour une meilleure exp√©rience ?')) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('PWA install√©e');
                            }
                            deferredPrompt = null;
                        });
                    } else {
                        localStorage.setItem('pwa_install_dismissed', 'true');
                    }
                }, 3000);
            }
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            loadOptions();
            showScreen('menuScreen');
            
            // Gestion du retour arri√®re sur mobile
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdzdWRva3UtdjEnOwpjb25zdCB1cmxzVG9DYWNoZSA9IFsKICAnLicsCiAgJy4vJwpdOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGV2ZW50LndhaXRVbnRpbCgKICAgIGNhY2hlcy5vcGVuKENBQ0hFX05BTUUpCiAgICAgIC50aGVuKGNhY2hlID0+IGNhY2hlLmFkZEFsbCh1cmxzVG9DYWNoZSkpCiAgKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4gewogIGV2ZW50LnJlc3BvbmRXaXRoKAogICAgY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QpCiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICByZXR1cm4gcmVzcG9uc2UgfHwgZmV0Y2goZXZlbnQucmVxdWVzdCk7CiAgICAgIH0pCiAgKTsKfSk7');
            }
        });
    </script>
</body>
</html>
