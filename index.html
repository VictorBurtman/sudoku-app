<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Sudoku</title>
    <meta name="theme-color" content="#2196F3">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="My Sudoku">
    
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
</head>
<body>
    <!-- Ton HTML inchangé -->

    <script>
        const appVersion = '1.1.3'; // version mise à jour

        const soundManager = {
            audioContext: null,
            soundBuffers: {},
            isInitialized: false,
            loadingPromise: null,
            isMobileDevice: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent),
            soundQueue: [],
            isPlaying: false,
            soundConfig: {
                intro: `sounds/intro.mp3?v=${appVersion}`,
                error: `sounds/error.mp3?v=${appVersion}`,
                victory: `sounds/victory.mp3?v=${appVersion}`,
                button1: `sounds/button1.mp3?v=${appVersion}`,
                button2: `sounds/button2.mp3?v=${appVersion}`,
                pop4: `sounds/pop4.mp3?v=${appVersion}`,
                pop5: `sounds/pop5.mp3?v=${appVersion}`,
                completion1: `sounds/completion1.mp3?v=${appVersion}`,
                completion2: `sounds/completion2.mp3?v=${appVersion}`
            },

            init: function() {
                if (this.isInitialized) return Promise.resolve();
                return new Promise((resolve) => {
                    try {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        this.audioContext = new AudioContext();

                        const unlockWithSilentSound = () => {
                            if (this.audioContext.state === 'suspended') {
                                this.audioContext.resume();
                            }
                            const buffer = this.audioContext.createBuffer(1, 1, 22050);
                            const source = this.audioContext.createBufferSource();
                            source.buffer = buffer;
                            source.connect(this.audioContext.destination);
                            source.start(0);
                        };

                        ['click','touchstart','touchend','mousedown','keydown'].forEach(event => {
                            document.addEventListener(event, () => {
                                unlockWithSilentSound();
                            }, { once: false });
                        });

                        this.loadingPromise = this.loadAllSounds();
                        this.isInitialized = true;
                    } catch (e) {
                        console.error('Audio init failed:', e);
                    }
                });
            },

            loadAllSounds: async function() {
                if (!this.audioContext) return;
                const soundPromises = Object.entries(this.soundConfig).map(async ([name, url]) => {
                    try {
                        const response = await fetch(url);
                        const arrayBuffer = await response.arrayBuffer();
                        const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                        this.soundBuffers[name] = audioBuffer;
                    } catch (e) {
                        console.error(`Failed to load sound: ${name}`, e);
                    }
                });
                await Promise.all(soundPromises);
            },

            enqueueSound: function(name) {
                if (!options.soundEnabled) return;
                this.soundQueue.push(name);
                this.playNextInQueue();
            },

            playNextInQueue: async function() {
                if (this.isPlaying || this.soundQueue.length === 0) return;
                this.isPlaying = true;

                const name = this.soundQueue.shift();
                let duration = 500;

                try {
                    if (this.audioContext && this.soundBuffers[name]) {
                        const source = this.audioContext.createBufferSource();
                        source.buffer = this.soundBuffers[name];
                        source.connect(this.audioContext.destination);
                        duration = source.buffer.duration * 1000;
                        source.start(0);
                    } else {
                        const audio = new Audio(this.soundConfig[name]);
                        duration = await new Promise(res => {
                            audio.onloadedmetadata = () => res(audio.duration * 1000);
                            audio.play().catch(() => res(500));
                        });
                    }
                } catch (e) {
                    console.error("Error playing sound:", e);
                }

                setTimeout(() => {
                    this.isPlaying = false;
                    this.playNextInQueue();
                }, duration + 50);
            },

            playPopSound: function() {
                const popSounds = ['pop4','pop5'];
                const randomSound = popSounds[Math.floor(Math.random() * popSounds.length)];
                this.enqueueSound(randomSound);
            },

            playCompletionSound: function() {
                const completionSounds = ['completion1','completion2'];
                const randomSound = completionSounds[Math.floor(Math.random() * completionSounds.length)];
                this.enqueueSound(randomSound);
            }
        };

        // Remplacement global des appels soundManager.playSound('xxx') par soundManager.enqueueSound('xxx')
    </script>
</body>
</html>
