<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sudoku Assistant - Technique Analyzer</title>
    <meta name="theme-color" content="#121212">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
        font-family: 'Courier New', monospace;
        background: #121212;
        color: #ffffff;
        min-height: 100vh;
    }

    .app-container {
        max-width: 480px;
        margin: 0 auto;
        background: #1e1e1e;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .app-bar {
        background: #2d2d2d;
        padding: 12px 16px;
        border-bottom: 1px solid #404040;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .app-bar h1 { font-size: 18px; color: #ffffff; }

    .back-button, .sudoku-wiki-button {
        background: none;
        border: none;
        color: #ffffff;
        font-size: 18px;
        cursor: pointer;
        padding: 8px;
        opacity: 0.8;
        border-radius: 4px;
    }

    .back-button:hover, .sudoku-wiki-button:hover {
        opacity: 1;
        background: rgba(255,255,255,0.1);
    }

    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }

    .grid-section {
        padding: 16px;
        border-bottom: 1px solid #404040;
        display: flex;
        justify-content: center;
    }

    /* --- MODIFICATION CSS POUR LE CENTRAGE FINAL --- */
    .grid-wrapper {
        display: grid;
        /* Colonnes: labels gauche, espace, grille, espace, balance droite */
        grid-template-columns: 24px 5px auto 5px 24px;
        grid-template-rows: 24px 5px auto; /* Lignes: labels haut, espace, grille */
        align-items: center;
    }

    .coord-labels-row {
        grid-area: 1 / 3 / 2 / 4; /* Ligne 1, Colonne 3 (au dessus de la grille) */
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        width: 100%;
        height: 100%;
    }

    .coord-labels-col {
        grid-area: 3 / 1 / 4 / 2; /* Ligne 3, Colonne 1 (√† gauche de la grille) */
        display: grid;
        grid-template-rows: repeat(9, 1fr);
        width: 100%;
        height: 100%;
    }

    .coord-label {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #b0b0b0;
        font-weight: bold;
    }
    
    .sudoku-grid {
        grid-area: 3 / 3 / 4 / 4; /* Ligne 3, Colonne 3 */
        width: 300px;
        height: 300px;
        aspect-ratio: 1;
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        grid-template-rows: repeat(9, 1fr);
        border: 2px solid #ffffff;
        background: #2d2d2d;
    }

    .cell {
        border: 0.5px solid #666666;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        position: relative;
        background: #2d2d2d;
        color: #ffffff;
    }

    .cell:nth-child(3n):not(:nth-child(9n)) { border-right: 1px solid #ffffff; }
    .cell:nth-child(n+19):nth-child(-n+27), .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 1px solid #ffffff; }

    .cell.given { color: #ffffff; background: #2d2d2d; }
    .cell.filled { color: #90caf9; background: #2d2d2d; }
    .cell.highlighted { 
        background: #ffb74d !important; 
        color: #ffffff;
        animation: pulse 2s infinite;
    }

    .cell.highlighted-secondary {
        background: #ff9800 !important;
        color: #ffffff;
        opacity: 0.8;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .notes {
        position: absolute;
        top: 2px;
        left: 2px;
        right: 2px;
        bottom: 2px;
        font-size: 8px;
        color: #ffffff;
        line-height: 1.1;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        text-align: center;
        align-items: center;
    }

    /* --- NOUVEAU STYLE POUR LES CANDIDATS √Ä SUPPRIMER --- */
    .notes span.eliminated-candidate {
        color: #f44336;
        text-decoration: line-through;
        font-weight: bold;
    }

    .analysis-section { flex: 1; padding: 16px; overflow-y: auto; }
    .analysis-section h3 { color: #ffffff; margin-bottom: 16px; font-size: 16px; }
    .move-suggestion { background: #4caf50; color: white; padding: 16px; border-radius: 8px; margin-top: 16px; text-align: center; }
    .move-suggestion h4 { font-size: 16px; margin-bottom: 8px; }
    .move-suggestion p { font-size: 13px; margin-bottom: 4px; }
    .loading-state, .error-state { text-align: center; padding: 40px 20px; }
    .loading-state { color: #b0b0b0; }
    .error-state { color: #f44336; }
    .technique { background: #2d2d2d; border-left: 4px solid #2196f3; padding: 12px; margin-bottom: 12px; border-radius: 5px; border: 1px solid #404040; }
    .technique h4 { color: #2196f3; margin-bottom: 8px; font-size: 14px; }
    .technique p { font-size: 12px; line-height: 1.4; color: #b0b0b0; }
</style>
</head>
<body>
    <div class="app-container">
        <div class="app-bar">
            <button class="back-button" onclick="window.close()">‚Üê</button>
            <h1>Sudoku Assistant v2.5</h1>
            <button class="sudoku-wiki-button" onclick="copyToClipboardAndOpenSudokuWiki()" title="Copy grid and open SudokuWiki">üß©</button>
        </div>

        <div class="main-content">
            <div class="grid-section" id="gridSection"></div>
            <div class="analysis-section" id="analysisSection">
                <h3>Technique Analysis</h3>
                <div id="analysisResult">
                    <div class="loading-state">Loading grid...</div>
                </div>
            </div>
        </div>
    </div>

<script>
    let currentGrid = null;
    let originalGrid = null;
    let notesGrid = null;

    // ... Fonctions utilitaires (showError, etc.) ...
    function showError(message) { /* ... */ }
    function showLoading(message) { /* ... */ }
    function showTemporaryMessage(message) { /* ... */ }
    function formatGridForSudokuWiki() { /* ... */ return ""; }
    function copyToClipboardAndOpenSudokuWiki() { /* ... */ }
    function loadDataFromURL() { /* ... */ return true; }
    function isValidPlacement(row, col, num) { /* ... */ return true; }
    
    function analyzeGrid() {
        // Pour les tests, on peut injecter une grille ici
        // Si aucune donn√©e n'est charg√©e, on arr√™te.
        if (!currentGrid) {
             // Utilisons une grille connue pour avoir un X-Wing
            const testData = {"currentGrid":[[0,0,2,8,0,0,0,0,0],[0,0,0,0,0,0,0,7,0],[4,0,0,0,9,0,0,0,0],[0,0,0,0,0,0,0,0,1],[0,0,0,6,0,5,0,0,0],[7,0,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,0,6],[0,4,0,0,0,0,0,0,0],[0,0,0,0,0,2,5,0,0]],"notesGrid":[[15,16,[],[],1345,134,1349,139,3459],[156,1356,156,134,2345,134,123489,[],234589],[[],1356,156,134,[],134,12389,23589,23589],[235689,2356,3568,2347,2347,47,234789,23589,[]],[12389,123,138,[],247,[],234789,23589,2345789],[[],23,38,12479,247,1479,234789,23589,2345789],[2389,23789,3789,23479,[],34789,23478,123489,[]],[1238,[],1378,1379,3678,136789,123,13489,23478],[1389,136789,136789,13479,34678,[],[],13489,23478]]};
            // On s'assure que les notes sont des tableaux de nombres
            testData.notesGrid = testData.notesGrid.map(row => row.map(cell => Array.isArray(cell) ? cell.join('').split('').map(Number) : []));
            currentGrid = testData.currentGrid;
            originalGrid = testData.originalGrid || JSON.parse(JSON.stringify(testData.currentGrid));
            notesGrid = testData.notesGrid;
        }
        
        if (!currentGrid || !notesGrid) {
            showError('Missing grid data for analysis.');
            return;
        }
        try {
            displayGrid();
            performAnalysis();
        } catch (error) {
            showError('Analysis error: ' + error.message);
        }
    }

    function displayGrid() {
        let topLabelsHtml = '<div class="coord-labels-row">';
        for (let i = 1; i <= 9; i++) topLabelsHtml += `<div class="coord-label">C${i}</div>`;
        topLabelsHtml += '</div>';

        let leftLabelsHtml = '<div class="coord-labels-col">';
        for (let i = 1; i <= 9; i++) leftLabelsHtml += `<div class="coord-label">R${i}</div>`;
        leftLabelsHtml += '</div>';

        let gridHtml = '<div class="sudoku-grid">';
        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                const cellValue = currentGrid[r][c];
                const notes = notesGrid[r][c] || [];
                // --- MODIFICATION POUR LES NOTES INDIVIDUELLES ---
                let notesHtml = '';
                if (cellValue === 0 && notes.length > 0) {
                    const notesSpans = Array(9).fill('');
                    notes.forEach(n => {
                        notesSpans[n-1] = `<span data-note="${n}">${n}</span>`;
                    });
                    notesHtml = notesSpans.join('');
                }
                
                gridHtml += `<div class="cell" data-row="${r}" data-col="${c}">
                    ${cellValue !== 0 ? cellValue : ''}
                    ${notesHtml ? `<div class="notes">${notesHtml}</div>` : ''}
                </div>`;
            }
        }
        gridHtml += '</div>';

        const finalHtml = `<div class="grid-wrapper">${topLabelsHtml}${leftLabelsHtml}${gridHtml}</div>`;
        document.getElementById('gridSection').innerHTML = finalHtml;
    }

    // ... Fonctions de d√©tection ...
    function findLastPossibleNumber() { return null; }
    function findHiddenSingle() { return null; }
    function findLineBoxReduction() { return null; }

    function findXWing() {
        for (let digit = 1; digit <= 9; digit++) {
            // Column-based X-Wing
            const colsWithTwo = [];
            for (let c = 0; c < 9; c++) {
                const rows = [];
                for (let r = 0; r < 9; r++) if (currentGrid[r][c] === 0 && (notesGrid[r][c] || []).includes(digit)) rows.push(r);
                if (rows.length === 2) colsWithTwo.push({ col: c, rows: rows });
            }
            if (colsWithTwo.length >= 2) {
                for (let i = 0; i < colsWithTwo.length; i++) {
                    for (let j = i + 1; j < colsWithTwo.length; j++) {
                        const col1 = colsWithTwo[i], col2 = colsWithTwo[j];
                        if (col1.rows.toString() === col2.rows.toString()) {
                            const [r1, r2] = col1.rows, [c1, c2] = [col1.col, col2.col];
                            // --- MODIFICATION : renvoyer des donn√©es structur√©es ---
                            let eliminations = [];
                            for (const r of [r1, r2]) {
                                for (let c = 0; c < 9; c++) {
                                    if (c !== c1 && c !== c2 && currentGrid[r][c] === 0 && (notesGrid[r][c] || []).includes(digit)) {
                                        eliminations.push({ r, c, val: digit });
                                    }
                                }
                            }
                            if (eliminations.length > 0) return { cells: [{r: r1, c: c1}, {r: r1, c: c2}, {r: r2, c: c1}, {r: r2, c: c2}], eliminations: eliminations, explanation: `X-Wing on digit ${digit} in columns ${c1 + 1} & ${c2 + 1}.`, reasoning: `This removes ${digit} from other cells in rows ${r1 + 1} & ${r2 + 1}.` };
                        }
                    }
                }
            }
            // Row-based X-Wing
            // ... (logique similaire)
        }
        return null;
    }

    function performAnalysis() {
        // ... cha√Ænage des techniques
        const xWing = findXWing();
        if (xWing) return displayAnalysis("X-Wing", xWing);

        displayAnalysis(null, null);
    }

    function displayAnalysis(foundTechnique, suggestion) {
        let html = '';
        if (suggestion) {
            document.querySelectorAll('.cell').forEach(cell => cell.classList.remove('highlighted', 'highlighted-secondary'));
            
            if (suggestion.cells) {
                 suggestion.cells.forEach(cellInfo => {
                    const targetCell = document.querySelector(`[data-row="${cellInfo.r}"][data-col="${cellInfo.c}"]`);
                    if (targetCell) targetCell.classList.add('highlighted');
                });
            }

            // --- NOUVELLE LOGIQUE POUR HIGHLIGHTER LES CANDIDATS ---
            let eliminationsText = [];
            if (suggestion.eliminations && suggestion.eliminations.length > 0) {
                suggestion.eliminations.forEach(elim => {
                    const cell = document.querySelector(`[data-row="${elim.r}"][data-col="${elim.c}"]`);
                    if (cell) {
                        const noteSpan = cell.querySelector(`.notes span[data-note="${elim.val}"]`);
                        if (noteSpan) {
                            noteSpan.classList.add('eliminated-candidate');
                        }
                    }
                    eliminationsText.push(` ${elim.val} from R${elim.r + 1}C${elim.c + 1}`);
                });
            }

            html = `
                <div class="move-suggestion">
                    <h4>üéØ ${foundTechnique}</h4>
                    <p>${suggestion.explanation}</p>
                    <p><em>${suggestion.reasoning}</em></p>
                    ${eliminationsText.length > 0 ? `<p><strong>‚ùå Remove:${eliminationsText.join(',')}</strong></p>` : ''}
                </div>
            `;
        } else {
            html = `<div class="technique"><h4>üß© No simple techniques detected.</h4><p>This grid may require more advanced techniques.</p></div>`;
        }
        document.getElementById('analysisResult').innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', function() {
        showLoading('Loading data...');
        setTimeout(() => {
            // Remplac√© par un chargement de donn√©es de test pour la d√©mo
             analyzeGrid();
            /*
            if (!loadDataFromURL()) {
                showError('No grid found. Open this page from the Sudoku app.');
            }
            */
        }, 100);
    });
</script>

</body>
</html>
