<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sudoku Assistant - Technique Analyzer</title>
    <meta name="theme-color" content="#121212">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
        font-family: 'Courier New', monospace;
        background: #121212;
        color: #ffffff;
        min-height: 100vh;
    }

    .app-container {
        max-width: 480px;
        margin: 0 auto;
        background: #1e1e1e;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .app-bar {
        background: #2d2d2d;
        padding: 12px 16px;
        border-bottom: 1px solid #404040;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .app-bar h1 { font-size: 18px; color: #ffffff; }

    .back-button, .sudoku-wiki-button {
        background: none;
        border: none;
        color: #ffffff;
        font-size: 18px;
        cursor: pointer;
        padding: 8px;
        opacity: 0.8;
        border-radius: 4px;
    }

    .back-button:hover, .sudoku-wiki-button:hover {
        opacity: 1;
        background: rgba(255,255,255,0.1);
    }

    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }

    .grid-section {
        padding: 16px;
        border-bottom: 1px solid #404040;
        /* --- MODIFICATION CSS POUR LE CENTRAGE --- */
        display: flex;
        justify-content: center;
    }

    .grid-wrapper {
        display: grid;
        grid-template-columns: 24px 1fr;
        grid-template-rows: 24px 1fr;
        gap: 5px;
        /* Le margin: auto n'est plus n√©cessaire gr√¢ce au flex du parent */
    }

    .coord-labels-row {
        grid-area: 1 / 2 / 2 / 3;
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        width: 100%;
        height: 100%;
    }

    .coord-labels-col {
        grid-area: 2 / 1 / 3 / 2;
        display: grid;
        grid-template-rows: repeat(9, 1fr);
        width: 100%;
        height: 100%;
    }

    .coord-label {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #b0b0b0;
        font-weight: bold;
    }
    
    .sudoku-grid {
        grid-area: 2 / 2 / 3 / 3;
        width: 300px; /* Taille fixe pour la pr√©visibilit√© */
        height: 300px;
        aspect-ratio: 1;
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        grid-template-rows: repeat(9, 1fr);
        border: 2px solid #ffffff;
        background: #2d2d2d;
    }

    .cell {
        border: 0.5px solid #666666;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        position: relative;
        background: #2d2d2d;
        color: #ffffff;
    }

    .cell:nth-child(3n):not(:nth-child(9n)) { border-right: 1px solid #ffffff; }
    .cell:nth-child(n+19):nth-child(-n+27), .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 1px solid #ffffff; }

    .cell.given { color: #ffffff; background: #2d2d2d; }
    .cell.filled { color: #90caf9; background: #2d2d2d; }
    .cell.highlighted { 
        background: #ffb74d !important; 
        color: #ffffff;
        animation: pulse 2s infinite;
    }

    .cell.highlighted-secondary {
        background: #ff9800 !important;
        color: #ffffff;
        opacity: 0.8;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .notes {
        position: absolute;
        top: 1px;
        left: 1px;
        font-size: 6px;
        color: #ffffff;
        line-height: 1;
    }

    .analysis-section {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
    }

    .analysis-section h3 {
        color: #ffffff;
        margin-bottom: 16px;
        font-size: 16px;
    }

    .move-suggestion {
        background: #4caf50;
        color: white;
        padding: 16px;
        border-radius: 8px;
        margin-top: 16px;
        text-align: center;
    }

    .move-suggestion h4 { font-size: 16px; margin-bottom: 8px; }
    .move-suggestion p { font-size: 13px; margin-bottom: 4px; }

    .loading-state, .error-state {
        text-align: center;
        padding: 40px 20px;
    }

    .loading-state { color: #b0b0b0; }
    .error-state { color: #f44336; }

    .technique {
        background: #2d2d2d;
        border-left: 4px solid #2196f3;
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 5px;
        border: 1px solid #404040;
    }

    .technique h4 { color: #2196f3; margin-bottom: 8px; font-size: 14px; }
    .technique p { font-size: 12px; line-height: 1.4; color: #b0b0b0; }
    
</style>
</head>
<body>
    <div class="app-container">
        <div class="app-bar">
            <button class="back-button" onclick="window.close()">‚Üê</button>
            <h1>Sudoku Assistant v2.5</h1>
            <button class="sudoku-wiki-button" onclick="copyToClipboardAndOpenSudokuWiki()" title="Copy grid and open SudokuWiki">üß©</button>
        </div>

    <div class="main-content">
        <div class="grid-section" id="gridSection">
            </div>
        
        <div class="analysis-section">
            <h3>Technique Analysis</h3>
            <div id="analysisResult">
                <div class="loading-state">Loading grid...</div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentGrid = null;
    let originalGrid = null;
    let notesGrid = null;

    function showError(message) {
        document.getElementById('analysisResult').innerHTML = `<div class="error-state">${message}</div>`;
        console.error('Error:', message);
    }

    function showLoading(message) {
        document.getElementById('analysisResult').innerHTML = `<div class="loading-state">${message}</div>`;
    }

    function showTemporaryMessage(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; background: #4caf50; color: white;
            padding: 12px 20px; border-radius: 6px; z-index: 1000; font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); max-width: 300px;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 4000);
    }

    function formatGridForSudokuWiki() {
        // Implementation...
        return "";
    }

    function copyToClipboardAndOpenSudokuWiki() {
        // Implementation...
    }

    function loadDataFromURL() {
        // Implementation...
        return true; // Assume success for brevity
    }

    function analyzeGrid() {
        if (!currentGrid || !notesGrid) {
            // Test data for demonstration
            const testData = {"originalGrid":[[0,0,0,0,0,6,0,0,0],[0,0,0,0,0,0,0,0,4],[3,0,9,0,0,0,0,0,0],[0,0,0,0,0,0,0,2,0],[0,0,0,8,0,3,0,0,0],[0,4,0,0,0,0,0,0,0],[0,0,0,0,0,0,7,0,9],[5,0,0,0,0,0,0,0,0],[0,0,0,5,0,0,0,0,0]],"currentGrid":[[0,0,0,0,0,6,0,0,0],[0,0,0,0,0,0,0,0,4],[3,0,9,0,0,0,0,0,0],[0,0,0,0,0,0,0,2,0],[0,0,0,8,0,3,0,0,0],[0,4,0,0,0,0,0,0,0],[0,0,0,0,0,0,7,0,9],[5,0,0,0,0,0,0,0,0],[0,0,0,5,0,0,0,0,0]], "notesGrid": [[{"1":true,"2":true,"4":true,"7":true,"8":true},{"1":true,"2":true,"5":true,"7":true,"8":true},{"1":true,"2":true,"4":true,"5":true,"7":true,"8":true},{"1":true,"2":true,"3":true,"4":true,"7":true,"9":true},{"1":true,"2":true,"4":true,"5":true,"7":true,"9":true},{},{"1":true,"3":true,"5":true,"8":true,"9":true},{"1":true,"3":true,"5":true},{"1":true,"2":true,"3":true,"5":true,"8":true}],[{"1":true,"2":true,"6":true,"7":true,"8":true},{"1":true,"2":true,"5":true,"6":true,"7":true,"8":true},{"1":true,"2":true,"5":true,"6":true,"7":true,"8":true},{"1":true,"2":true,"3":true,"7":true,"9":true},{"1":true,"2":true,"5":true,"7":true,"9":true},{"1":true,"2":true,"5":true,"7":true,"8":true,"9":true},{"1":true,"3":true,"5":true,"6":true,"8":true,"9":true},{"1":true,"3":true,"5":true,"6":true},{}],[{},{"1":true,"2":true,"5":true,"6":true,"7":true,"8":true},{},{"1":true,"2":true,"4":true,"7":true,"9":true},{"1":true,"2":true,"4":true,"5":true,"7":true,"9":true},{"1":true,"2":true,"4":true,"5":true,"7":true,"8":true,"9":true},{"1":true,"5":true,"6":true,"8":true,"9":true},{"1":true,"5":true,"6":true},{"1":true,"2":true,"5":true,"6":true,"8":true}],[{"1":true,"6":true,"8":true},{"1":true,"3":true,"5":true,"6":true,"7":true,"8":true},{"1":true,"3":true,"5":true,"6":true,"7":true,"8":true},{"1":true,"4":true,"6":true,"7":true,"9":true},{"1":true,"4":true,"5":true,"7":true,"9":true},{"1":true,"4":true,"5":true,"7":true,"9":true},{"1":true,"3":true,"5":true,"6":true,"9":true},{},{"1":true,"3":true,"5":true,"6":true}],[{"1":true,"2":true,"6":true,"7":true},{"1":true,"5":true,"6":true,"7":true},{"1":true,"2":true,"5":true,"6":true,"7":true},{},{"1":true,"2":true,"4":true,"5":true,"7":true,"9":true},{},{"1":true,"5":true,"6":true,"9":true},{"1":true,"6":true},{"1":true,"5":true,"6":true}],[{"1":true,"2":true,"6":true,"8":true,"9":true},{},{"1":true,"2":true,"3":true,"6":true,"8":true},{"1":true,"2":true,"6":true,"7":true,"9":true},{"1":true,"2":true,"7":true,"9":true},{"1":true,"2":true,"7":true,"9":true},{"1":true,"3":true,"5":true,"6":true,"9":true},{"1":true,"3":true,"5":true,"6":true},{"1":true,"3":true,"5":true,"6":true,"8":true}],[{"1":true,"2":true,"4":true,"6":true,"8":true},{"1":true,"2":true,"3":true,"6":true,"8":true},{"1":true,"2":true,"3":true,"4":true,"6":true,"8":true},{"1":true,"2":true,"3":true,"4":true,"6":true},{"1":true,"2":true,"4":true,"8":true},{"1":true,"2":true,"4":true,"8":true},{},{"1":true,"3":true,"5":true,"6":true,"8":true},{}],[{},{"1":true,"2":true,"3":true,"6":true,"7":true,"8":true},{"1":true,"2":true,"3":true,"4":true,"6":true,"7":true,"8":true},{"1":true,"2":true,"3":true,"4":true,"6":true,"7":true,"9":true},{"1":true,"2":true,"3":true,"4":true,"7":true,"9":true},{"1":true,"2":true,"4":true,"7":true,"8":true,"9":true},{"1":true,"3":true,"4":true,"8":true,"9":true},{"1":true,"3":true,"6":true,"8":true},{"2":true,"3":true,"6":true,"8":true}],[{"1":true,"2":true,"4":true,"6":true,"7":true,"8":true,"9":true},{"1":true,"2":true,"3":true,"6":true,"7":true,"8":true,"9":true},{"1":true,"2":true,"3":true,"4":true,"6":true,"7":true,"8":true},{"{},{"1":true,"2":true,"3":true,"7":true,"9":true},{"1":true,"2":true,"7":true,"8":true,"9":true},{"1":true,"2":true,"3":true,"8":true,"9":true},{"1":true,"3":true,"6":true,"8":true},{"2":true,"3":true,"6":true,"8":true}]]};
            // The user's provided grid seems to be solved, this is a better test case for X-Wing from a known source.
            // Converting notes to the app's format (array of numbers)
            testData.notesGrid = testData.notesGrid.map(row => row.map(cell => cell ? Object.keys(cell).map(Number) : []));
            currentGrid = testData.currentGrid;
            originalGrid = testData.originalGrid;
            notesGrid = testData.notesGrid;
        }

        try {
            displayGrid();
            performAnalysis();
        } catch (error) {
            showError('Analysis error: ' + error.message);
        }
    }

    function displayGrid() {
        // Implementation...
        let finalHtml = `<div class="grid-wrapper">...</div>`;
        document.getElementById('gridSection').innerHTML = finalHtml;
    }

    function isValidPlacement(row, col, num) {
        // Implementation...
        return true;
    }
    
    // ... Toutes les autres fonctions (findLastPossibleNumber, etc.) ...
    function findLineBoxReduction() {
        // Implementation...
        return null;
    }

    // --- NOUVELLE FONCTION X-WING ---
    function findXWing() {
        for (let digit = 1; digit <= 9; digit++) {
            // Column-based X-Wing
            const colsWithTwoCandidates = [];
            for (let c = 0; c < 9; c++) {
                const candidateRows = [];
                for (let r = 0; r < 9; r++) {
                    if (currentGrid[r][c] === 0 && (notesGrid[r][c] || []).includes(digit)) {
                        candidateRows.push(r);
                    }
                }
                if (candidateRows.length === 2) {
                    colsWithTwoCandidates.push({ col: c, rows: candidateRows });
                }
            }

            if (colsWithTwoCandidates.length >= 2) {
                for (let i = 0; i < colsWithTwoCandidates.length; i++) {
                    for (let j = i + 1; j < colsWithTwoCandidates.length; j++) {
                        const col1 = colsWithTwoCandidates[i];
                        const col2 = colsWithTwoCandidates[j];
                        
                        // Check if they share the same two rows
                        if (col1.rows[0] === col2.rows[0] && col1.rows[1] === col2.rows[1]) {
                            const r1 = col1.rows[0];
                            const r2 = col1.rows[1];
                            const c1 = col1.col;
                            const c2 = col2.col;
                            let eliminations = [];

                            // Check for eliminations in the first row
                            for (let c = 0; c < 9; c++) {
                                if (c !== c1 && c !== c2 && currentGrid[r1][c] === 0 && (notesGrid[r1][c] || []).includes(digit)) {
                                    eliminations.push(`R${r1 + 1}C${c + 1}`);
                                }
                            }
                            // Check for eliminations in the second row
                            for (let c = 0; c < 9; c++) {
                                if (c !== c1 && c !== c2 && currentGrid[r2][c] === 0 && (notesGrid[r2][c] || []).includes(digit)) {
                                    eliminations.push(`R${r2 + 1}C${c + 1}`);
                                }
                            }

                            if (eliminations.length > 0) {
                                return {
                                    type: 'elimination',
                                    cells: [{r: r1, c: c1}, {r: r1, c: c2}, {r: r2, c: c1}, {r: r2, c: c2}],
                                    value: digit,
                                    explanation: `X-Wing on digit ${digit} in columns ${c1 + 1} & ${c2 + 1} and rows ${r1 + 1} & ${r2 + 1}.`,
                                    reasoning: `This removes ${digit} as a candidate from other cells in these rows.`,
                                    eliminations: eliminations
                                };
                            }
                        }
                    }
                }
            }
             // Row-based X-Wing can be implemented with similar logic, swapping rows and columns.
        }
        return null;
    }


    function performAnalysis() {
        const lastNumber = findLastPossibleNumber();
        if (lastNumber) return displayAnalysis("Last Possible Digit", lastNumber);

        const hiddenSingle = findHiddenSingle();
        if (hiddenSingle) return displayAnalysis("Hidden Single", hiddenSingle);

        const hasUserNotes = notesGrid.some(row => row.some(cell => cell && cell.length > 0));
        if (hasUserNotes) {
            // ... autres techniques
            const lineBox = findLineBoxReduction();
            if (lineBox) return displayAnalysis("Line/Box Reduction", lineBox);

            // --- INT√âGRATION DE X-WING ---
            const xWing = findXWing();
            if (xWing) return displayAnalysis("X-Wing", xWing);
        }

        displayAnalysis(null, null);
    }

    function displayAnalysis(foundTechnique, suggestion) {
        // Implementation... (Ensure it correctly handles the 'cells' array with 4 corners for highlighting)
        let html = `<div class="move-suggestion">...</div>`;
        document.getElementById('analysisResult').innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', function() {
        analyzeGrid(); // Using test data from analyzeGrid function
    });
</script>

</body>
</html>
